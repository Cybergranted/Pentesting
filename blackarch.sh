#!/bin/bash

# Paths
PACMAN_CONF="/etc/pacman.conf"

# Functions
enable_blackarch() {
    echo "Enabling BlackArch repository..."

    # Uncomment the BlackArch repository
    sudo sed -i '/#\[blackarch\]/{N;s/#\[blackarch\]\n#Server/\[blackarch\]\nServer/}' "$PACMAN_CONF"

    # Update the package databases
    sudo pacman -Syyu --noconfirm

    echo "BlackArch repository enabled and updated."
}

disable_blackarch() {
    echo "Disabling BlackArch repository..."

    # Comment the BlackArch repository
    sudo sed -i '/\[blackarch\]/{N;s/\[blackarch\]\nServer/#\[blackarch\]\n#Server/}' "$PACMAN_CONF"

    # Update the package databases
    sudo pacman -Sy

    echo "BlackArch repository disabled."
}

search_package() {
    echo "Searching for packages..."
    
    # Use pacman to list all packages with their details, filter with fzf, and store selected package
    package_info=$(pacman -Sl | fzf --prompt="Search for a package: " --multi)
    
    if [ -n "$package_info" ]; then
        package_name=$(echo "$package_info" | awk '{print $2}')
        show_package_details "$package_name"
    else
        echo "No package selected."
    fi
}

show_package_details() {
    package=$1
    
    echo "Package details for: $package"
    pacman -Si "$package"
    
    echo -n "Do you want to install this package? [y/N]: "
    read -r confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        install_package "$package"
    else
        echo "Installation cancelled."
    fi
}

install_package() {
    package=$1
    
    echo "Installing package: $package"

    # Install the package with all dependencies
    sudo pacman -S --needed "$package"
}

# Main menu
while true; do
    clear
    echo "BlackArch Repository Management"
    echo "-------------------------------"
    echo "1. Enable BlackArch Repository"
    echo "2. Disable BlackArch Repository"
    echo "3. Search and Install Packages"
    echo "4. Exit"
    echo -n "Choose an option: "
    read -r option

    case $option in
        1)
            enable_blackarch
            ;;
        2)
            disable_blackarch
            ;;
        3)
            search_package
            ;;
        4)
            echo "Exiting..."
            exit 0
            ;;
        *)
            echo "Invalid option, please try again."
            ;;
    esac

    # Pause before showing the menu again
    echo -n "Press any key to continue..."
    read -r -n 1
done
